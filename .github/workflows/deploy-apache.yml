name: Build and deploy Apache to k8s

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to container registry
        run: echo "${{ secrets.HARBOR_PASS }}" | docker login -u robot\$jooble registry.jooble.com  --password-stdin

      - name: Build image
        run: docker build -t registry.jooble.com/default/apache-dpo:${{ github.run_id }} .

      - name: Push image
        run: docker push registry.jooble.com/default/apache-dpo:${{ github.run_id }}

      - name: Export image metadata
        id: build_image
        run: echo "image=registry.jooble.com/default/apache-dpo:${{ github.run_id }}" >> $GITHUB_OUTPUT

    outputs:
      image: ${{ steps.build_image.outputs.image }}


  deploy:
    runs-on: self-hosted
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Add kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Check docker version
        run: |
          docker -v

      - name: Deploy Apache manifests
        run: |
          IMAGE=${{ needs.build.outputs.image }}
          echo "Deploying image: $IMAGE"
          kubectl set image deployment/apache-deployment apache=$IMAGE -n default || kubectl apply -f manifests/
          kubectl rollout status deployment/apache-deployment -n default
